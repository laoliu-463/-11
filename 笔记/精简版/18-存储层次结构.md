# 18-存储层次结构

> 存储层次、局部性原理、SRAM vs DRAM  
> 最后更新：2025年1月

---

## 📑 目录

- [一、存储层次结构](#一存储层次结构)
- [二、局部性原理](#二局部性原理)
- [三、SRAM vs DRAM](#三sram-vs-dram)
- [四、DRAM刷新](#四dram刷新)
- [五、总结](#五总结)

---

## 一、存储层次结构

### 什么是存储层次结构？

**定义：** 存储层次结构是指计算机系统中不同速度和容量的存储器按层次组织的结构，从快到慢、从贵到便宜、从容量小到容量大。

**通俗理解：** 存储层次结构就像"多级仓库系统"：最常用的东西放在最靠近（CPU寄存器），次常用的放在第二层（Cache），不常用的放在远处（硬盘）。这样既能快速访问常用数据，又能存储大量数据。

### 完整层次

```
CPU寄存器  <1ns     几十个      极高
    ↓
L1 Cache   1ns      32-64KB     很高
    ↓
L2 Cache   5ns      256KB-1MB   高
    ↓  
L3 Cache   15ns     8-32MB      较高
    ↓
主存DRAM   100ns    4-64GB      中
    ↓
SSD        10μs     128GB-4TB   较低
    ↓
HDD        5ms      1-20TB      低

速度：从上到下越来越慢
容量：从上到下越来越大
成本：从上到下越来越便宜
```

### 层次结构图示

```
┌─────────────────────────────────────────┐
│         存储层次金字塔                    │
└─────────────────────────────────────────┘

            ┌──────────┐
            │ 寄存器   │ ← 最快、最贵、最小
            └────┬─────┘
                 │
            ┌────▼─────┐
            │ L1 Cache │ ← 很快、很贵、较小
            └────┬─────┘
                 │
            ┌────▼─────┐
            │ L2 Cache │ ← 快、贵、中等
            └────┬─────┘
                 │
            ┌────▼─────┐
            │ L3 Cache │ ← 较快、较贵、较大
            └────┬─────┘
                 │
            ┌────▼─────┐
            │  主存    │ ← 中等、中等、大
            └────┬─────┘
                 │
            ┌────▼─────┐
            │   SSD    │ ← 较慢、便宜、很大
            └────┬─────┘
                 │
            ┌────▼─────┐
            │   HDD    │ ← 最慢、最便宜、最大
            └──────────┘
```

### 性能参数对比

| 存储类型 | 访问时间 | 容量 | 成本/GB | 应用 |
|---------|---------|------|---------|------|
| **寄存器** | <1ns | 几十个 | 极高 | CPU内部 |
| **L1 Cache** | 1ns | 32-64KB | 很高 | CPU内部 |
| **L2 Cache** | 5ns | 256KB-1MB | 高 | CPU内部 |
| **L3 Cache** | 15ns | 8-32MB | 较高 | CPU内部 |
| **主存DRAM** | 100ns | 4-64GB | 中 | 主板 |
| **SSD** | 10μs | 128GB-4TB | 较低 | 存储设备 |
| **HDD** | 5ms | 1-20TB | 低 | 存储设备 |

---

## 二、局部性原理

### 什么是局部性原理？

**定义：** 局部性原理是指程序在执行过程中，对数据和指令的访问具有时间和空间上的局部性特征。

**通俗理解：** 局部性原理就像"工作习惯"：
- **时间局部性**：刚用过的工具可能还会用
- **空间局部性**：附近的工具可能也要用

### 时间局部性

**通俗理解：** 就像"刚用过的工具可能还会用"，CPU刚访问的数据很可能再次访问。

```
特点：
  • 刚访问的数据很可能再次访问
  • 循环变量被反复访问
  • 函数参数被多次使用

示例：
  for (int i = 0; i < 1000; i++) {
      sum += i;  // i被反复访问，应该在Cache中
  }
  
  说明：
    i在循环中被反复访问
    应该放在Cache中，提高访问速度
```

### 空间局部性

**通俗理解：** 就像"附近的工具可能也要用"，访问一个数据时，相邻的数据也很可能被访问。

```
特点：
  • 相邻的数据很可能被访问
  • 数组顺序访问
  • 指令顺序执行

示例：
  int[] array = new int[1000];
  for (int i = 0; i < 1000; i++) {
      array[i] = i;  // 相邻元素连续访问
  }
  
  说明：
    访问array[0]时，array[1], array[2]等很可能也被访问
    Cache会预取相邻数据
```

### 局部性原理的应用

```
Cache设计基于局部性：
  • 时间局部性 → Cache存储最近访问的数据
  • 空间局部性 → Cache按块存储（一次取一块）

优化建议：
  • 提高时间局部性：重用变量，减少重复计算
  • 提高空间局部性：顺序访问数组，避免随机访问
```

---

## 三、SRAM vs DRAM

### 什么是SRAM和DRAM？

**通俗理解：**
- **SRAM（静态RAM）**：就像"不需要充电的电池"，用触发器存储，速度快但贵，用于Cache
- **DRAM（动态RAM）**：就像"需要定期充电的电池"，用电容存储，需要刷新，但便宜，用于主存

### 对比表

| 特性 | SRAM | DRAM |
|------|------|------|
| **存储原理** | 触发器（6个晶体管） | 电容（1个晶体管） |
| **速度** | 快（1-10ns） | 慢（50-100ns） |
| **密度** | 低 | 高 |
| **刷新** | 不需要 | 需要（2-64ms） |
| **价格** | 贵 | 便宜 |
| **功耗** | 高 | 低 |
| **应用** | Cache | 主存 |

### SRAM结构

```
SRAM存储单元（6管）：
  ┌─────────┐
  │ 触发器  │ ← 用6个晶体管实现
  │         │   稳定，不需要刷新
  └─────────┘

特点：
  • 速度快（1-10ns）
  • 不需要刷新
  • 但成本高、密度低
  • 用于Cache
```

### DRAM结构

```
DRAM存储单元（1管1电容）：
  ┌─────────┐
  │  电容   │ ← 用电容存储电荷
  │         │   需要定期刷新
  └─────────┘

特点：
  • 成本低、密度高
  • 但需要刷新（电荷会泄漏）
  • 速度较慢（50-100ns）
  • 用于主存
```

### 为什么DRAM需要刷新？

```
原因：
  • DRAM用电容存储电荷
  • 电容会漏电，电荷会丢失
  • 必须定期刷新（重新充电）

刷新周期：
  • 典型：64ms内刷新所有行
  • 刷新方式：集中、分散、异步

类比：
  就像"需要定期给电池充电"
  不刷新，数据就会丢失
```

---

## 四、DRAM刷新

### 三种刷新方式

**通俗理解：** DRAM刷新就像"给电池充电"，有三种方式：集中充电（统一充）、分散充电（分散充）、异步充电（均匀充）。

```
1. 集中刷新
   特点：统一刷新，有死时间
   方式：64ms内集中刷新所有行
   问题：刷新期间不能访问（死时间）

2. 分散刷新
   特点：分散插入，无死区但慢
   方式：每次访问后刷新一行
   问题：每次访问都变慢

3. 异步刷新 ⭐推荐
   特点：均匀分布，平衡性能和死时间
   方式：64ms内均匀刷新所有行
   优点：平衡性能和死时间
```

### 刷新方式对比

| 刷新方式 | 死时间 | 性能影响 | 应用 |
|---------|--------|---------|------|
| **集中刷新** | 有 | 大 | 不常用 |
| **分散刷新** | 无 | 中 | 不常用 |
| **异步刷新** | 小 | 小 | 常用 |

### 刷新计算示例

```
假设：
  • DRAM有8192行
  • 刷新周期：64ms
  • 每行刷新时间：100ns

计算：
  总刷新时间 = 8192 × 100ns = 819.2μs
  刷新间隔 = 64ms / 8192 ≈ 7.8μs
  
  说明：
    每7.8μs刷新一行
    64ms内刷新完所有行
```

---

## 五、总结

### 核心要点

```
✅ 存储层次：从快到慢、从贵到便宜、从容量小到容量大
✅ 局部性原理：时间局部性 + 空间局部性
✅ SRAM：快、贵、用于Cache
✅ DRAM：慢、便宜、用于主存
✅ DRAM需要刷新：异步刷新最常用
```

### 关键理解

- **存储层次**：通过多级存储平衡速度和容量
- **时间局部性**：刚访问的数据很可能再次访问
- **空间局部性**：相邻的数据很可能被访问
- **SRAM**：触发器存储，快但贵，用于Cache
- **DRAM**：电容存储，慢但便宜，用于主存，需要刷新

### 性能优化

```
优化方向：
  • 提高Cache命中率（利用局部性）
  • 优化程序访问模式（顺序访问）
  • 减少随机访问（破坏空间局部性）
  • 重用数据（提高时间局部性）
```

---

**最后更新：** 2025年1月










