# 17-条件执行与流控制

> 条件执行、条件码、流控制指令  
> 最后更新：2025年1月

---

## 📑 目录

- [一、什么是条件执行？](#一什么是条件执行)
- [二、条件码寄存器](#二条件码寄存器)
- [三、条件执行 vs 条件分支](#三条件执行-vs-条件分支)
- [四、流控制指令](#四流控制指令)
- [五、总结](#五总结)

---

## 一、什么是条件执行？

### 定义

**定义：** 条件执行是指CPU根据某个条件决定是否执行某条指令。ARM的特色是每条指令都可以添加条件码，根据条件码决定是否执行，避免分支预测失败，提高性能。

**通俗理解：** 条件执行就像"只在对的时候才写答案"，CPU根据某个条件决定是否执行某条指令。普通情况是无论对错都要写答案（条件分支），条件执行是只在对的时候才写答案，不对就不写，但继续往下做（无需跳转）。

### 核心思想

```
条件执行 = 根据条件决定是否执行指令

类比：
  条件分支：无论对错，都要写答案（需要跳转）
  条件执行：只在对的时候才写答案（无需跳转）

优势：
  • 避免分支预测失败
  • 提高流水线效率
  • 减少跳转开销
```

---

## 二、条件码寄存器

### 什么是条件码？

**通俗理解：** 条件码就像"状态标志"，记录上次运算的结果（正负、零、进位、溢出），用于条件判断。

```
条件码寄存器（PSW/NZCV）：
  • N (Negative)：负数标志
  • Z (Zero)：零标志
  • C (Carry)：进位标志
  • V (Overflow)：溢出标志

设置时机：
  • 算术运算后自动设置
  • CMP指令显式设置
```

### 条件码设置

```
示例：ADD R1, R2, R3
  结果 = R2 + R3
  
  如果结果 < 0：N = 1
  如果结果 = 0：Z = 1
  如果结果 > 0：N = 0, Z = 0
  
  如果溢出：V = 1
  如果有进位：C = 1
```

---

## 三、条件执行 vs 条件分支

### 方式1：条件分支（传统方式）

**通俗理解：** 就像"跳来跳去"，需要跳转指令，可能分支预测失败。

```
传统方式（条件分支）：
  CMP  R0, R1    // 比较两个数
  BNE  skip      // 不相等就跳走
  ADD  R2, R3    // 相等才执行
skip:
  SUB  R4, R5    // 继续执行

问题：
  • 有跳转指令，会打断程序流程
  • 可能分支预测失败，浪费CPU时间
  • 代码需要跳来跳去
```

### 方式2：条件执行（ARM特色）

**通俗理解：** 就像"顺序执行"，无需跳转，条件满足就执行，不满足就跳过。

```
ARM方式（条件执行）：
  CMP  R0, R1    // 比较两个数
  ADDEQ R2, R3   // 相等就执行ADD
  SUB  R4, R5    // 继续执行（无论是否相等）

优势：
  • 无需跳转，顺序执行
  • 避免分支预测失败
  • 提高流水线效率
```

### 对比

| 特性 | 条件分支 | 条件执行 |
|------|---------|---------|
| **跳转** | 需要 | 不需要 |
| **分支预测** | 可能失败 | 无影响 |
| **流水线** | 可能停顿 | 连续 |
| **性能** | 较慢 | 较快 |
| **代码** | 跳来跳去 | 顺序 |

---

## 四、流控制指令

### 条件码

**通俗理解：** 条件码就像"判断条件"，根据条件码决定是否执行。

```
常用条件码：
  EQ：相等（Z=1）
  NE：不等（Z=0）
  GT：大于（Z=0且N=V）
  LT：小于（N≠V）
  GE：大于等于（N=V）
  LE：小于等于（Z=1或N≠V）
  AL：总是执行（无条件）
```

### 条件执行示例

```
示例1：相等时执行
  CMP  R0, R1    // 比较R0和R1
  ADDEQ R2, R3   // 如果相等，R2 = R2 + R3
  SUB  R4, R5    // 继续执行

示例2：不等时执行
  CMP  R0, R1
  ADDNE R2, R3   // 如果不等，R2 = R2 + R3
  SUB  R4, R5

示例3：大于时执行
  CMP  R0, R1
  ADDGT R2, R3   // 如果R0>R1，R2 = R2 + R3
  SUB  R4, R5
```

### 流控制指令类型

```
1. 条件分支
   BEQ target    // 相等则跳转
   BNE target    // 不等则跳转
   BGT target    // 大于则跳转

2. 条件执行
   ADDEQ R1, R2  // 相等则执行ADD
   SUBLT R1, R2  // 小于则执行SUB

3. 循环控制
   LOOP:
     ...
     CMP R0, R1
     BNE LOOP    // 不等则继续循环
```

---

## 五、总结

### 核心要点

```
✅ 条件执行 = 根据条件决定是否执行指令
✅ 条件码：N、Z、C、V标志
✅ 条件执行 vs 条件分支：无需跳转，性能更好
✅ ARM特色：每条指令都可以添加条件码
✅ 流控制：条件分支、条件执行、循环控制
```

### 关键理解

- **条件执行**：根据条件决定是否执行，无需跳转
- **条件码**：N、Z、C、V标志，记录运算结果
- **优势**：避免分支预测失败，提高流水线效率
- **ARM特色**：每条指令都可以添加条件码
- **流控制**：条件分支、条件执行、循环控制

### 性能优势

```
性能提升：
  • 避免分支预测失败（节省10-20个周期）
  • 提高流水线效率（连续执行）
  • 减少跳转开销（无需修改PC）
  • 代码更紧凑（减少跳转指令）

应用场景：
  • 短条件判断（1-2条指令）
  • 避免分支预测失败
  • 提高代码密度
```

---

**最后更新：** 2025年1月









