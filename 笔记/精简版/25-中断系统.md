# 25-中断系统

> 中断处理流程、中断优先级、中断嵌套  
> 最后更新：2025年1月

---

## 📑 目录

- [一、什么是中断？](#一什么是中断)
- [二、中断分类](#二中断分类)
- [三、中断处理流程](#三中断处理流程)
- [四、中断优先级](#四中断优先级)
- [五、中断向量表](#五中断向量表)
- [六、总结](#六总结)

---

## 一、什么是中断？

### 定义

**定义：** 中断是CPU正常执行程序的流程被外部事件打断，转去处理该事件，处理完后返回原程序继续执行的机制。

**通俗理解：** 中断就像"门铃响了"：你在看书（CPU执行程序），门铃响（中断请求），你去开门（处理中断），处理完回来继续看书（返回原程序）。中断让CPU能够及时响应外部事件，而不需要一直轮询检查。

### 中断的作用

```
中断的本质：
  • 异步事件：随时可能发生
  • 打断当前：暂停当前任务
  • 处理事件：执行中断处理程序
  • 恢复原状：返回被打断的地方继续

作用：
  • 提高CPU利用率（不用轮询）
  • 及时响应外部事件
  • 实现多任务处理
  • 处理异常情况
```

---

## 二、中断分类

### 按来源分类

**通俗理解：** 中断可以按来源分为"内部事件"（内中断）和"外部事件"（外中断）。内中断是CPU内部的问题，外中断是外部设备需要CPU帮忙。

```
中断分类：
┌─────────────────────────────────────┐
│         中断分类                    │
├─────────────────────────────────────┤
│  内中断（异常/陷阱）                │
│  ├─ 硬件故障：除零、溢出、缺页      │
│  ├─ 软件中断：系统调用（INT指令）   │
│  └─ 陷阱：调试断点                  │
│                                     │
│  外中断（硬件中断）                │
│  ├─ 可屏蔽中断：I/O设备中断（IRQ）  │
│  └─ 不可屏蔽中断：电源故障（NMI）   │
└─────────────────────────────────────┘
```

### 内中断（异常）

**特点：**
- 由CPU内部事件引起
- 与当前指令执行相关
- 通常必须立即处理

**类型：**
- **故障（Fault）**：可恢复（如缺页）
- **陷阱（Trap）**：系统调用
- **中止（Abort）**：严重错误，可能无法恢复

### 外中断（硬件中断）

**特点：**
- 由外部设备请求
- 与当前指令执行无关
- 可屏蔽中断可以延迟处理

**类型：**
- **可屏蔽中断**：可通过中断屏蔽位禁止
- **不可屏蔽中断（NMI）**：必须立即处理（如电源故障）

---

## 三、中断处理流程

### 完整流程

**通俗理解：** 中断处理就像"接电话"：保存当前工作（保存断点）、接电话（处理中断）、挂电话后继续工作（恢复断点）。

```
中断处理8步骤：

步骤1: 保存断点
  SP ← SP - 4
  M[SP] ← PC（保存PC）
  M[SP-4] ← PSW（保存PSW）
  SP ← SP - 4

步骤2: 关中断
  IE ← 0（中断使能位清0）
  防止中断处理被打断（除非允许嵌套）

步骤3: 识别中断源
  读取中断状态寄存器
  判断哪个设备请求
  确定中断向量

步骤4: 转中断服务程序
  PC ← 中断向量表[n]
  n是中断类型编号

步骤5: 中断服务程序执行
  保存现场(寄存器)
  执行中断处理代码
  清除中断请求标志
  恢复现场(寄存器)

步骤6: 恢复断点
  PSW ← M[SP]
  SP ← SP + 4
  PC ← M[SP]
  SP ← SP + 4

步骤7: 开中断
  IE ← 1（中断使能位置1）
  允许响应新的中断

步骤8: 返回
  执行IRET指令
  继续原程序
```

### 中断时序图

```
主程序执行中:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
时间:  T1  T2  T3  T4  T5  T6  T7  T8  T9  T10
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: I1  I2  I3  ──  ──  ──  ──  ──  ──  I4
                   ↑                   ↑
                 中断请求             中断返回
                   │                   │
中断服务:          ├→ 保存 ISR ISR ISR ISR 恢复 ─┤
                      断点  1   2   3   4  断点
```

### 中断响应条件

```
中断响应条件：
  1. 中断源发出中断请求 (INT=1)
  2. 中断使能位IE=1
  3. 当前指令执行完毕

检查时机: 每条指令执行结束时

伪代码:
while (true) {
    执行当前指令;
    if (IE == 1 && INT == 1) {
        保存断点;
        关中断;
        跳转到中断服务程序;
    }
}
```

---

## 四、中断优先级

### 什么是中断优先级？

**通俗理解：** 中断优先级就像"紧急程度"，多个中断同时发生时，优先级高的先处理。

### 优先级排序

```
中断优先级排序 (典型):
┌─────────────────────┐
│ 1. 硬件故障中断      │ ← 最高优先级
│ 2. 程序性中断(异常)   │
│ 3. 外部中断          │
│    • 时钟中断        │
│    • I/O中断         │
│ 4. 软件中断          │ ← 最低优先级
└─────────────────────┘

中断优先级链:
  高优先级可以打断低优先级中断
  低优先级不能打断高优先级中断
```

### 中断嵌套

**通俗理解：** 中断嵌套就像"紧急电话可以打断普通电话"，高优先级中断可以打断低优先级中断的处理。

```
无嵌套 (单级中断):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: ════╗           ╔═══
            ║           ║
中断A:       ╚═══════════╝
            关中断     开中断

有嵌套 (多级中断):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: ════╗                 ╔═══
            ║                 ║
中断A:       ╚═════╗       ╔═══╝
                   ║       ║
中断B(高优先):      ╚═══════╝
                  关中断   开中断
```

---

## 五、中断向量表

### 什么是中断向量表？

**通俗理解：** 中断向量表就像"电话簿"，存储各种中断的服务程序入口地址。

### 中断向量表结构

```
中断向量表: 存储中断服务程序入口地址

地址      中断类型        服务程序地址
────────────────────────────────────
0x0000    复位           0x00100000
0x0004    除零异常       0x00100100
0x0008    非法指令       0x00100200
0x000C    溢出异常       0x00100300
0x0010    键盘中断       0x00100400
0x0014    定时器中断     0x00100500
0x0018    磁盘中断       0x00100600
...

中断响应过程:
  1. 读取中断类型n
  2. 查表: PC ← M[向量表基址 + n×4]
  3. 跳转到服务程序
```

### 中断向量表示例

```
中断类型编号 → 服务程序地址

示例：
  键盘中断：类型=4
  查表：向量表[4] = 0x00100400
  跳转：PC ← 0x00100400
  执行键盘中断服务程序
```

---

## 六、总结

### 核心要点

```
✅ 中断 = 异步事件打断当前程序
✅ 中断分类：内中断（异常）vs 外中断（硬件中断）
✅ 中断处理：保存断点 → 处理 → 恢复断点
✅ 中断优先级：高优先级可打断低优先级
✅ 中断向量表：存储服务程序入口地址
```

### 关键理解

- **中断**让CPU能及时响应外部事件，不用轮询
- **内中断**是CPU内部问题，**外中断**是外部设备请求
- **中断处理**必须保存和恢复现场
- **中断优先级**决定多个中断的处理顺序
- **中断向量表**快速定位服务程序

### 中断 vs 子程序调用

| 特性 | 中断 | 子程序调用 |
|------|------|-----------|
| **触发** | 异步(随机发生) | 同步(CALL指令) |
| **返回地址** | 硬件自动保存 | CALL指令保存 |
| **现场保护** | 可能需要保存所有 | 通常只保存必要寄存器 |
| **优先级** | 有优先级机制 | 无 |
| **嵌套** | 支持中断嵌套 | 支持递归调用 |
| **指令** | IRET | RET |

---

**最后更新：** 2025年1月









