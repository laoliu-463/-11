# A4 处理器结构与控制

> CPU组成、指令执行、控制器与流水线  
> 涵盖原文：13-CPU结构、14-指令执行周期、15-控制器设计、16-流水线技术、17-条件执行与流控制  
> 最后更新：2025年1月

---

## 📑 目录

- [一、CPU内部结构](#一cpu内部结构)
- [二、指令执行流程](#二指令执行流程)
- [三、控制器设计](#三控制器设计)
- [四、流水线技术](#四流水线技术)
- [五、条件执行与流控制](#五条件执行与流控制)
- [六、典型考点速查](#六典型考点速查)

---

## 一、CPU内部结构

### 1. 核心组成
```
┌────────────┐
│ 运算器 ALU │ ← 算术逻辑运算
├────────────┤
│ 控制器 CU  │ ← 产生控制信号
├────────────┤
│ 寄存器组   │ ← PC、IR、MAR、MDR...
└────────────┘
```
- **PC**：指向下一条指令地址
- **IR**：存放当前指令
- **MAR/MDR**：访存地址寄存器 / 数据寄存器
- **通用寄存器**：暂存操作数、提高访问速度

### 2. 数据通路
- 单总线、双总线、三总线结构 → **总线越多，允许的并行操作越多**
- 常考：画出“取数→运算→写回”的数据流向图

---

## 二、指令执行流程

### 1. 基本周期
1. **取指**：`MAR ← PC`，`MDR ← M[MAR]`，`IR ← MDR`
2. **译码**：CU解析操作码、寻址方式
3. **取操作数**：根据寻址方式访问寄存器/存储器
4. **执行**：ALU完成运算，设置条件码
5. **写回**：结果写回寄存器或存储器
6. **更新PC**：顺序 or 跳转

### 2. RTL表示法
- 例：`R1 ← R2 + R3` → `T1: MAR ← R2`、`T2: MDR ← M[MAR]`、...
- 考试常让“补全RTL步骤”

---

## 三、控制器设计

### 1. 硬布线控制器
- 控制逻辑由组合/时序电路实现
- **优点**：速度快；**缺点**：修改困难

### 2. 微程序控制器
- 控制信号由微指令序列产生 (`ROM` 存储微程序)
- **优点**：易修改、适合复杂指令；**缺点**：访问微程序存在延迟
- 微指令格式：垂直、水平；微地址生成方式：直接、间接、映象

---

## 四、流水线技术

### 1. 五级流水线
```
IF → ID → EX → MEM → WB
取指 译码 执行 访存 写回
```
- **吞吐率**：`n / (k + n - 1)` → 理想状态下趋近于 `1 / Δt`
- **加速比**：`时间串行 / 时间流水`

### 2. 三大冒险详解
| 类型 | 触发原因 | 解决方法 | 性能影响 |
|------|----------|----------|---------|
| **结构冒险** | 资源冲突（如同时访存） | 哈佛结构、资源复制 | 无影响 |
| **数据冒险** | RAW/WAR/WAW依赖 | 前递技术 ⭐、阻塞 | 小/中 |
| **控制冒险** | 分支指令 | 分支预测 ⭐、延迟槽 | 小/大 |

#### 数据冒险详解（RAW最常见）
```
ADD R1, R2, R3  ← R1在WB写入
SUB R4, R1, R5  ← R1在ID读取（冒险！）

解决方案：
  • 前递：从EX/MEM直接转发R1到ALU输入（无延迟）
  • 阻塞：插入气泡等待（有延迟）
```

#### 分支预测（高频考点）
```
静态预测：
  • 总是预测跳转 / 总是不跳转
  • 向后跳转预测跳转（BTFN）

动态预测：⭐ 常用
  • 2位饱和计数器（00/01/10/11）
  • 局部预测器 vs 全局预测器
  • 混合预测器（结合两者）

分支目标缓冲(BTB)：
  • 缓存分支地址和目标地址
  • 减少取指延迟
```

> 高频：画时间-阶段图，标出冒险并给出解决策略；掌握分支预测算法

---

## 五、条件执行与流控制

### 1. 条件码
- **CF**：进位/借位；**ZF**：结果为0；**SF**：符号；**OF**：溢出
- 条件转移指令根据条件码判断跳转

### 2. 流控制机制
- **条件转移**、**无条件转移**、**循环指令**、**调用/返回**
- 高级处理方式：条件执行（ARM的`s`后缀）、分支预测、延迟分支

---

## 六、典型考点速查

| 题型 | 提示 |
|------|------|
| RTL补全题 | 按“取指→译码→执行→写回”顺序写，注意寄存器更新 |
| 控制器比较 | 记住“硬布线快但难改，微程序灵活但慢” |
| 流水线冒险 | 先标出数据依赖，再选择前递/插入气泡 |
| 条件码题 | 运算结束后立刻判断标志位变化 |

---

详细推导和实例可查阅原主题 `13~17`。
