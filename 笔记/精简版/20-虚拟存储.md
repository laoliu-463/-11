# 20-虚拟存储

> 页式管理、TLB快表、缺页处理、页面置换算法  
> 最后更新：2025年1月

---

## 📑 目录

- [一、什么是虚拟存储？](#一什么是虚拟存储)
- [二、页式管理](#二页式管理)
- [三、TLB快表](#三tlb快表)
- [四、缺页处理](#四缺页处理)
- [五、页面置换算法](#五页面置换算法)
- [六、总结](#六总结)

---

## 一、什么是虚拟存储？

### 定义

**定义：** 虚拟存储是一种存储管理技术，让程序以为自己有很多内存，实际上物理内存可能不够。操作系统自动把不常用的数据放到硬盘，需要时再调回来。

**通俗理解：** 虚拟存储就像"虚拟内存"，让程序以为自己有很多内存，实际上物理内存可能不够。操作系统自动把不常用的数据放到硬盘，需要时再调回来，就像"无限大的内存"。

### 核心思想

```
虚拟存储 = 虚拟地址空间 + 物理地址空间

特点：
  • 程序使用虚拟地址（大）
  • 实际存储在物理地址（小）
  • 操作系统自动管理映射
  • 不常用的页放在磁盘

类比：
  虚拟地址 = 门牌号（可以很大）
  物理地址 = 实际房间（有限）
  操作系统 = 管理员（负责映射）
```

---

## 二、页式管理

### 什么是页式管理？

**通俗理解：** 页式管理就像"把内存分成固定大小的页"，就像把书分成固定页数的章节，方便管理。

```
页式管理：
  • 虚拟地址空间分成页（Page）
  • 物理地址空间分成页框（Page Frame）
  • 页和页框大小相同（通常4KB）
  • 通过页表映射
```

### 地址转换

```
虚拟地址:
┌────────┬────────┐
│ 页号P  │ 偏移d  │
└───┬────┴────────┘
    ↓ 查页表
物理地址:
┌────────┬────────┐
│ 页框号 │ 偏移d  │
└────────┴────────┘

转换过程：
  1. 提取页号P和偏移d
  2. 查页表：页框号 = 页表[P]
  3. 物理地址 = 页框号 × 页大小 + 偏移d
```

### 页表项结构

```
页表项（Page Table Entry）：
┌─┬─┬─┬─┬────┐
│V│D│R│W│ PFN │
└─┴─┴─┴─┴────┘
 │ │ │ │  物理页框号
 │ │ │ 可写
 │ │ 已访问
 │ 脏位
有效位(0=缺页)

V (Valid): 有效位
  • 1：页在内存中
  • 0：页不在内存中（缺页）

D (Dirty): 脏位
  • 1：页被修改过
  • 0：页未被修改

R (Referenced): 已访问位
  • 1：最近被访问过
  • 0：最近未访问

W (Writable): 可写位
  • 1：可写
  • 0：只读

PFN (Page Frame Number): 物理页框号
```

### 地址转换示例

**示例：虚拟地址 0x1234 → 物理地址**

```
假设：
  页大小 = 4KB = 0x1000
  虚拟地址 = 0x1234

步骤：
  1. 提取页号和偏移：
     页号 = 0x1234 / 0x1000 = 1
     偏移 = 0x1234 % 0x1000 = 0x234
  
  2. 查页表：
     页表[1] = 页框号5（假设）
  
  3. 计算物理地址：
     物理地址 = 5 × 0x1000 + 0x234 = 0x5234

图示：
  虚拟地址 0x1234
    ↓
  页号=1, 偏移=0x234
    ↓
  查页表[1] = 页框5
    ↓
  物理地址 = 0x5234
```

---

## 三、TLB快表

### 什么是TLB？

**定义：** TLB（Translation Lookaside Buffer，快表）是缓存页表项的高速缓存，用于加速地址转换。

**通俗理解：** TLB就像"地址翻译的Cache"，缓存常用的页表项，避免每次都查页表，大大加速地址转换。

### TLB工作流程

```
地址转换流程：
  1. 查TLB
     ↓ 命中(98%)
     直接使用，快！
     ↓ 失效
  2. 查页表
     ↓
  3. 更新TLB
     ↓
  4. 使用转换结果

性能提升: 30-50倍
```

### TLB结构

```
TLB项结构：
┌──────────┬──────────┬──────────┐
│虚拟页号  │物理页框号 │有效位等  │
└──────────┴──────────┴──────────┘

TLB特点：
  • 容量小（64-512项）
  • 速度快（1-2个周期）
  • 命中率高（>95%）
  • 全相联或组相联
```

---

## 四、缺页处理

### 什么是缺页？

**通俗理解：** 缺页就像"要看的书不在书架上"，需要的页不在内存中，必须从磁盘调入。

```
缺页条件：
  • 页表项V=0（页不在内存）
  • 访问该页时触发缺页异常

缺页处理流程：
  1. 查页表，V=0
  2. 触发缺页异常
  3. 选择牺牲页(LRU/FIFO)
  4. 若脏页，写回磁盘
  5. 从磁盘调入新页
  6. 更新页表
  7. 重新执行指令

缺页惩罚: 5-10ms (极慢)
必须保持高命中率>99%
```

### 缺页处理示例

```
场景：访问虚拟页5，但页5不在内存

步骤：
  1. 查页表[5]，V=0 → 缺页
  2. 触发缺页异常
  3. 选择牺牲页（假设页2）
  4. 检查页2的D位：
     • D=1：写回磁盘
     • D=0：直接丢弃
  5. 从磁盘读取页5到页框2
  6. 更新页表[5]：V=1, PFN=2
  7. 重新执行原指令
```

---

## 五、页面置换算法

### 什么是页面置换？

**通俗理解：** 页面置换就像"图书馆书架"，书架满了（内存满），新书要放进来（新页要调入），必须拿走一本旧书（置换一个旧页），置换算法决定拿走哪本书。

### 算法分类

```
页面置换算法：
  1. OPT（最优算法）- 理论最优，不可实现
  2. FIFO（先进先出）- 简单但性能一般
  3. LRU（最近最少使用）⭐ 最常用
  4. Clock算法 - 近似LRU，硬件简单
```

### 1. FIFO（先进先出）

**通俗理解：** 就像"排队"，最先进入内存的页最先被置换出去。

```
原理：
  置换最先进入内存的页
  使用队列记录进入顺序

优点：
  ✓ 实现简单

缺点：
  ✗ 可能把有用的页置换掉
  ✗ 性能一般

示例：
  访问序列：1, 2, 3, 4, 1, 2, 5
  内存容量：3页
  
  1: [1]          缺页
  2: [1,2]        缺页
  3: [1,2,3]      缺页
  4: [2,3,4]      缺页，置换1
  1: [3,4,1]      缺页，置换2
  2: [4,1,2]      缺页，置换3
  5: [1,2,5]      缺页，置换4
  
  缺页次数：7次
```

### 2. LRU（最近最少使用）⭐最常用

**通俗理解：** 就像"扔掉最久没看的书"，置换最长时间未使用的页。

```
原理：
  置换最长时间未使用的页
  记录每页的最后访问时间

优点：
  ✓ 符合局部性原理
  ✓ 性能好

缺点：
  ✗ 实现复杂（需要记录访问时间）

示例：
  访问序列：1, 2, 3, 4, 1, 2, 5
  内存容量：3页
  
  1: [1]          缺页
  2: [1,2]        缺页
  3: [1,2,3]      缺页
  4: [1,2,4]      缺页，置换3（最久未用）
  1: [1,2,4]      命中
  2: [1,2,4]      命中
  5: [1,2,5]      缺页，置换4（最久未用）
  
  缺页次数：5次（比FIFO好）
```

### 3. Clock算法（近似LRU）

**通俗理解：** 就像"时钟指针"，用一个指针循环扫描，找到第一个R=0的页置换。

```
原理：
  近似LRU，硬件实现简单
  使用访问位R，指针循环扫描

算法：
  1. 指针指向一个页
  2. 如果R=1：R←0，指针++
  3. 如果R=0：置换该页，指针++
  4. 重复步骤2-3

优点：
  ✓ 硬件实现简单
  ✓ 性能接近LRU

缺点：
  ✗ 不如LRU精确
```

### 算法对比

| 算法 | 原理 | 优点 | 缺点 | 缺页率 |
|------|------|------|------|--------|
| **OPT** | 置换未来最久不用的 | 理论最优 | 不可实现 | 最低 |
| **FIFO** | 先进先出 | 实现简单 | 性能一般 | 高 |
| **LRU** | 最近最少使用 | 性能好 | 实现复杂 | 低 |
| **Clock** | 近似LRU | 硬件简单 | 不如LRU | 中低 |

---

## 六、总结

### 核心要点

```
✅ 虚拟存储 = 虚拟地址 + 物理地址映射
✅ 页式管理：页和页框大小相同，通过页表映射
✅ TLB：缓存页表项，加速地址转换
✅ 缺页处理：从磁盘调入，需要页面置换
✅ 页面置换：LRU最常用，Clock近似LRU
```

### 关键理解

- **虚拟存储**让程序使用大地址空间，实际物理内存可能较小
- **页式管理**通过页表映射虚拟页到物理页框
- **TLB**缓存常用页表项，大大提高转换速度
- **缺页处理**非常慢，必须保持高命中率
- **页面置换算法**影响系统性能，LRU最常用

### 性能指标

```
关键指标：
  • 缺页率：越低越好（<1%）
  • TLB命中率：越高越好（>95%）
  • 平均访存时间：越短越好

优化方向：
  • 增大物理内存（减少缺页）
  • 增大TLB（提高命中率）
  • 优化程序访问模式（提高局部性）
```

---

**最后更新：** 2025年1月










