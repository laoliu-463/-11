# 19-Cache技术：极速缓存的艺术

> **核心视角**：Cache 是一个**哈希表 (Hash Table)**。
> 它将巨大的主存地址空间映射到极小的 SRAM 空间中。所有的设计（直接映射、组相联）本质上都是在权衡**哈希冲突**与**查找速度**。
> 最后更新：2025年1月

---

## 一、Cache 的逻辑结构图 (Class Diagram)

Cache 不是一个简单的数组，它是一个精心设计的**多维结构**。

```mermaid
classDiagram
    class Cache系统 {
        +命中率 : 浮点数
        +访问时间 : 纳秒
        +读取(地址)
        +写入(地址, 数据)
    }

    class Cache组 {
        +组索引 : 整数
        +替换策略 : LRU或随机
        +查找行(标记)
    }

    class Cache行 {
        +有效位 : 布尔
        +脏位 : 布尔
        +标记 : 整数
        +数据块 : 字节数组
        +匹配(标记)
    }

    class 地址 {
        +标记 : 整数
        +索引 : 整数
        +偏移 : 整数
    }

    Cache系统 "1" *-- "N" Cache组 : 包含(多个组)
    Cache组 "1" *-- "K" Cache行 : 包含(K路)
    
    note for Cache组 "K = 1: 直接映射\nK = N: 全相联\n1 < K < N: 组相联"
    
    地址 ..> Cache系统 : 输入到
```

### 结构拆解
1.  **Cache系统**：整体控制器。
2.  **Cache组 (Set)**：哈希桶。通过地址的 `索引` 字段定位到具体的组。
3.  **Cache行 (Line/Block)**：最小存储单元。
    *   **有效位**：这行数据是有效的吗？
    *   **脏位**：这行数据被修改过吗？（写回策略用）
    *   **标记**：这行数据属于主存的哪个位置？（身份ID）
    *   **数据**：实际的数据内容（通常 64 字节）。

---

## 二、映射方式：哈希策略的选择

如何根据内存地址找到 Cache 中的位置？这取决于 `索引` 和 `标记` 的划分。

### 1. 直接映射 (Direct Mapped) —— K=1
*   **规则**：每个内存块只能放在**唯一**的一个 Cache 行中。`Cache行号 = 内存块号 % Cache行数`。
*   **优点**：查找极快（不用比较，直接定位）。
*   **缺点**：**冲突严重**。如果程序交替访问映射到同一行的两个地址（如 `A` 和 `A + CacheSize`），会发生**抖动 (Thrashing)**。

### 2. 全相联 (Fully Associative) —— K=N
*   **规则**：内存块可以放在 Cache 的**任意**位置。
*   **优点**：冲突最少（只有 Cache 满了才会冲突）。
*   **缺点**：**查找极慢**。必须并发比较所有行的标记（电路复杂，功耗大）。

### 3. 组相联 (Set Associative) —— 1 < K < N (折中方案)
*   **规则**：内存块可以放在特定**组**内的**任意**一行中。
    *   先通过 `索引` 找到组。
    *   再在组内的 K 行中查找标记。
*   **主流选择**：现代 CPU 通常使用 **4路** 或 **8路** 组相联。

---

## 三、写策略：一致性的维护

当 CPU 修改了 Cache 中的数据，主存什么时候更新？

1.  **写直达 (Write Through)**：
    *   **策略**：每次写 Cache，同时也写主存。
    *   **优点**：主存始终是最新的，一致性好。
    *   **缺点**：**慢**。写操作被主存速度拖累。
2.  **写回 (Write Back)**：
    *   **策略**：只修改 Cache，标记为 **脏位**。只有当这行被**替换**出去时，才写回主存。
    *   **优点**：**快**。多次写合并为一次写。
    *   **缺点**：实现复杂，断电可能丢数据。

---

## 四、总结

*   Cache 是 CPU 性能的倍增器。
*   **组相联**结构在冲突和速度之间找到了完美的平衡点。
*   **写回**策略在速度和复杂性之间选择了速度。

---

## 核心考点与习题映射 (Exam Focus)
> **来源**：`102-内存系统练习题`, `104-期末综合练习题`

### 1. 高速缓存 (Cache)
*   **映射方式 (102-Q6, Q13)**：
    *   **直接映射 (Direct, K=1)**：僵化，冲突大。
    *   **全相联 (Fully Associative, K=M)**：灵活，成本高。
    *   **组相联 (Set Associative)**：折中。
*   **地址结构计算 (102-Q9)**：
    *   **公式**：Addr = Tag + Set + Offset。
    *   **Set** = $\text{BlockNum} \pmod{\text{Sets}}$。
    *   *例*：16行2路 $\to$ 8组。地址129 (块4) $\to$ 组4。
*   **写策略 (102-Q10, 104-Q4)**：
    *   **通写式 (Write-through)**：同时写 Cache 和主存 (简单，慢)。
    *   **写回式 (Write-back)**：只写 Cache，替换时才写回 (快，复杂，Dirty位)。
