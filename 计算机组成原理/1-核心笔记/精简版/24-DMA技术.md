# 24-DMA技术：数据搬运的专业外包

> **核心视角**：DMA (Direct Memory Access) 是一种**硬件协处理器**。它的唯一功能就是执行**数据拷贝函数**（`memcpy`），从而将 CPU 从繁重的搬砖工作（数据移动）中解放出来，让 CPU 专注于**逻辑计算**。
> 最后更新：2025年1月

---

## 一、为什么需要 DMA？

如果没有 DMA，从硬盘读取 1GB 数据到内存：
1.  硬盘控制器读出一个字。
2.  CPU 发出 `IN` 指令读到寄存器。
3.  CPU 发出 `STORE` 指令写入内存。
4.  重复 2.5 亿次。

**后果**：CPU 全程被占用，无法运行其他程序。CPU 变成了昂贵的搬运工。

---

## 二、DMA 的工作原理

DMA 控制器本质上是一个**简化的 CPU**，它只能执行一种指令：**块传输**。

### 1. 流程
1.  **预处理 (CPU)**：CPU 告诉 DMA 控制器：
    *   源地址（硬盘端口）
    *   目的地址（内存缓冲区）
    *   传输长度（1GB）
    *   "开始干活！"
2.  **数据传输 (DMA)**：
    *   DMA 向 CPU 申请总线控制权（总线窃取）。
    *   DMA 直接控制总线，将数据从源搬到目的。
    *   CPU 此时可以处理 Cache 中的指令，或者被挂起。
3.  **后处理 (Interrupt)**：
    *   搬运完成，DMA 发送**中断**通知 CPU。
    *   CPU 检查结果，继续后续逻辑。

### 2. 总线接管方式
*   **停止 CPU 访存**：DMA 霸占总线，CPU 暂停。
*   **周期挪用 (Cycle Stealing)**：CPU 不访存时（如执行乘法指令期间），DMA 偷着用一下总线。
*   **交替访存**：CPU 和 DMA 轮流用。

---

## 三、DMA 与 CPU 的关系

*   **主从关系**：CPU 是老板，DMA 是包工头。CPU 下达宏观指令，DMA 执行具体搬运。
*   **并行工作**：在 DMA 搬运数据的同时，CPU 可以并行执行其他不依赖总线的任务（如复杂的算术运算），实现了**CPU 计算**与**I/O 传输**的并行。

---

## 四、总结

*   DMA 是 I/O 性能提升的关键技术。
*   它体现了**专业分工**的思想：通用 CPU 处理复杂逻辑，专用 DMA 处理简单重复的数据搬运。
*   现代计算机中，显卡、网卡、硬盘控制器都内置了强大的 DMA 引擎（甚至称为总线主控 Bus Mastering）。

---

## 核心考点与习题映射 (Exam Focus)
> **来源**：`101-I-O系统练习题`

### 1. DMA (Direct Memory Access)
*   **与中断的区别**：
    *   中断方式：CPU 参与数据搬运（指令级干预）。
    *   DMA 方式：CPU 不参与数据搬运（硬件级传输），仅在开始和结束参与。
*   **总线控制**：
    *   **周期窃取 (Cycle Stealing)**：DMA 优先占用存取周期。
