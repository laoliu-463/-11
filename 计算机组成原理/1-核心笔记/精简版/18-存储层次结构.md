# 18-存储层次结构：速度与容量的博弈

> **核心视角**：存储层次结构是为了解决 CPU **函数执行速度**（极快）与**数据存储容量**（极大）之间的矛盾。它利用**局部性原理**，用金字塔式的结构欺骗 CPU，让它以为自己拥有一个**既快又大**的存储器。
> 最后更新：2025年1月

---

## 一、存储层次的类图 (Class Diagram)

存储层次结构本质上是一系列**存储接口**的实现，它们之间存在着**缓存 (Cache)** 与 **被缓存 (Backed By)** 的关系。

```mermaid
classDiagram
    %% 抽象基类
    class 存储设备 {
        <<抽象>>
        +容量 : 大小
        +延迟 : 时间
        +单位成本 : 价格
        +读取(地址)
        +写入(地址, 数据)
    }

    %% 具体实现类
    class 寄存器 {
        +容量: 小于1KB
        +延迟: 小于1ns
    }
    
    class L1_Cache {
        +容量: 32KB
        +延迟: 1ns
    }
    
    class L2_Cache {
        +容量: 256KB
        +延迟: 4ns
    }
    
    class 主存 {
        +容量: 16GB
        +延迟: 100ns
        +技术: DRAM
    }
    
    class 本地磁盘 {
        +容量: 1TB
        +延迟: 10ms
        +技术: SSD/HDD
    }

    %% 继承关系
    存储设备 <|-- 寄存器
    存储设备 <|-- L1_Cache
    存储设备 <|-- L2_Cache
    存储设备 <|-- 主存
    存储设备 <|-- 本地磁盘

    %% 缓存关系 (下一层是上一层的后备存储)
    寄存器 ..> L1_Cache : 溢出到
    L1_Cache ..> L2_Cache : 未命中时访问
    L2_Cache ..> 主存 : 未命中时访问
    主存 ..> 本地磁盘 : 交换到(虚拟内存)
```

这个图展示了：
1.  **统一接口**：所有存储设备在逻辑上都提供 `读取/写入` 功能。
2.  **层级链条**：当上一层（如 L1）找不到数据（Miss）时，会自动请求下一层（L2）。
3.  **属性差异**：越往下，容量越大，延迟越高。

---

## 二、核心矛盾：快、大、廉的不可能三角

在物理定律的限制下，存储器无法同时满足以下三点：
1.  **速度快**（匹配 CPU 主频）。
2.  **容量大**（存下海量数据）。
3.  **价格廉**（用户买得起）。

*   **SRAM (Static RAM)**：
    *   **原理**：用 6 个晶体管（触发器）锁住一个状态位。
    *   **特点**：**极快**（无需刷新），但**面积大、贵**。
    *   **位置**：Cache。
*   **DRAM (Dynamic RAM)**：
    *   **原理**：用 1 个电容存电荷。
    *   **特点**：**密、便宜**，但**慢**（需要刷新，电容充放电慢）。
    *   **位置**：主存。

---

## 三、局部性原理 (Locality)：存储层次的基石

如果程序访问数据是完全随机的，那么存储层次结构将毫无意义。好在，程序的行为是可以预测的。

### 1. 时间局部性 (Temporal Locality)
*   **现象**：如果一个数据项被访问了，那么它在不久的将来很可能**再次被访问**。
*   **例子**：循环变量 `i`，频繁调用的函数代码。
*   **对策**：将最近访问的数据保留在**高速缓存 (Cache)** 中。

### 2. 空间局部性 (Spatial Locality)
*   **现象**：如果一个数据项被访问了，那么与它**地址相邻**的数据项很可能很快被访问。
*   **例子**：数组遍历，顺序执行的指令流。
*   **对策**：从慢速存储器取数据时，不只取一个字，而是取一个**块 (Block/Line)**。

---

## 四、总结

*   存储层次结构是一个**缓存系统**。
*   上一层是下一层的**缓存**。
*   **局部性原理**保证了热点数据大部分时间都待在金字塔的顶端，从而让 CPU 享受到接近 SRAM 的速度和接近 DRAM 的容量。
