# A6 总线与 I/O 系统

> 总线结构、I/O接口、DMA 与中断系统  
> 涵盖原文：22-总线系统、23-I/O接口、24-DMA技术、25-中断系统  
> 最后更新：2025年1月

---

## 📑 目录

- [一、总线基础](#一总线基础)
- [二、I/O 接口与编址](#二io-接口与编址)
- [三、数据传送方式](#三数据传送方式)
- [四、DMA 工作机制](#四dma-工作机制)
- [五、中断系统](#五中断系统)
- [六、易错点总结](#六易错点总结)

---

## 一、总线基础

### 1. 总线分类
| 类型 | 功能 | 示例 |
|------|------|------|
| 内部总线 | CPU 内部数据通路 | ALU ↔ 寄存器 |
| 系统总线 | CPU ↔ 主存 / I/O | 数据总线、地址总线、控制总线 |
| 通信总线 | 计算机 ↔ 计算机 | PCIe、USB、以太网 |

### 2. 总线事务与时序
- 事务阶段：仲裁 → 设定地址 → 数据传输 → 结束
- 同步方式：同步总线（统一时钟）、异步总线（握手协议）

### 3. 仲裁方式
| 方式 | 特点 |
|------|------|
| 集中式（链式/计数器/并行） | 控制简单，扩展性一般 |
| 分布式 | 设备自行协商，硬件复杂 |

---

## 二、I/O 接口与编址

### 1. I/O 接口组成
```
┌─────────────┐
│ 数据寄存器  │ ← 与设备/CPU数据交换
│ 状态寄存器  │ ← 标志位（忙/就绪/错误）
│ 控制寄存器  │ ← 控制命令（启动/停止）
└─────────────┘
```

### 2. I/O 编址方式
- **独立编址** (I/O-mapped)：I/O空间独立，使用特殊指令 (`IN/OUT`)
- **统一编址** (Memory-mapped)：I/O与内存统一编址，使用通用访存指令

---

## 三、数据传送方式

| 方式 | 特点 | 适用场景 |
|------|------|----------|
| 程序查询 | CPU轮询状态 | 低速设备、简单实现 |
| 程序中断 | 设备准备好后发中断，CPU响应 | 中速设备，减少轮询开销 |
| DMA | 设备直接访问主存 | 大批量高速数据传输 |

> 考试常比较“CPU占用率、硬件复杂度、吞吐率”

---

## 四、DMA 工作机制

### 1. DMA 过程
```
① CPU 初始化 DMA 控制器（源地址、目的地址、传输长度）
② DMA 请求总线控制权
③ DMA 在获得总线后直接在主存 ↔ I/O 之间传输
④ 传输完成后通过中断通知 CPU
```
- 工作方式：字节传送、块传送、周期窃取、透明传送
- **优点**：减少CPU干预、提高吞吐
- **限制**：主存与I/O带宽受总线冲突影响

---

## 五、中断系统

### 1. 中断类型
| 类型 | 触发方式 | 举例 |
|------|----------|------|
| 外部中断 | 外设请求 | 键盘输入、定时器 |
| 内部中断 | 指令异常 | 溢出、非法操作码 |
| 访管指令 | 特权调用 | OS服务调用 |

### 2. 中断响应流程
1. CPU 完成当前指令
2. 保存现场（PC、PSW）
3. 分析中断源（中断向量表）
4. 执行中断服务程序 (ISR)
5. 恢复现场，返回原程序

### 3. 中断优先级与屏蔽
- 多级优先级；高优先级可打断低优先级
- 屏蔽字：控制哪些中断能被响应
- 嵌套中断：ISR 中再次响应更高优先级中断

---

## 六、易错点总结

### 总线与性能
- **总线带宽** = 数据线宽度 (bit) × 总线频率
- **总线冲突**：多个设备同时请求总线 → 需仲裁

### DMA 与 Cache 冲突（高频考点）
```
问题：
  DMA绕过CPU直接访问主存
  → CPU的Cache中可能有旧数据
  → 数据不一致

解决方案：
  1. 硬件方案：Cache一致性协议（MESI）
  2. 软件方案：DMA前清空Cache / DMA后刷新Cache
  3. 混合方案：DMA通知Cache更新
```

### 中断处理
- **现场保存顺序**：先硬件自动保存PC/PSW，再由软件决定是否保存寄存器
- **中断嵌套**：高优先级中断可打断低优先级ISR
- **程序查询 vs 中断**：判断关键在于 CPU 是否需要主动轮询

---

详尽流程、时序图与计算示例请见原主题 `22~25`。
