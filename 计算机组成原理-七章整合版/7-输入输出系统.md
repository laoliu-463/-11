# 第7章：程序执行与调用机制

> 目标：用最短时间把握“子程序调用 + 函数传参 + 程序执行流程”三大主线，并能根据索引跳到详细推导。  
> 覆盖主题：26-子程序调用、27-函数与参数、28-程序执行过程  
> 最后更新：2025 年 1 月

---

## 知识点简要介绍

1. **子程序调用与返回**  
   - CALL/RET（或 BL/RET）自动保存/恢复返回地址，配合栈完成跳转。  
   - 调用时序：准备参数 → 压栈返回地址 → 跳转 → 建栈帧 → 执行 → 处理返回值 → 恢复现场。

2. **栈帧结构与现场保护**  
   - 栈帧 = 返回地址 + 旧 FP + 参数 + 局部变量；递归/重入依赖独立栈帧。  
   - Caller-saved 寄存器在调用前保存，Callee-saved 在被调函数内保存。

3. **参数与返回值传递**  
   - 寄存器传参快但数量有限，栈传参灵活；混合模式最常见。  
   - ARM AAPCS：R0-R3 传前 4 个参数，返回值位于 R0（必要时用 R1/R2）。

4. **调用约定与可重入**  
   - CDECL / STDCALL / FASTCALL 决定压栈顺序和清栈责任。  
   - 可重入函数避免共享静态状态，递归需完整压栈/弹栈。

5. **程序执行三阶段**  
   - 编译：预处理 → 编译 → 汇编 → 链接，生成可执行文件。  
   - 加载：OS 创建进程、映射虚拟地址、初始化 PC/SP。  
   - 运行：CPU 在取指-译码-执行循环中配合流水线、缓存与中断。

6. **高频考点与易错点**  
   - 栈帧图、参数压栈方向、返回地址位置；执行时间 `T = 指令数 × CPI × 时钟周期`。  
   - 区分值/引用传递，理解堆栈增长方向与进程内存布局（Text/Data/BSS/Heap/Stack）。

---

## 详细内容索引

| 主题 | 原文笔记 | 说明 |
|------|-----------|------|
| 子程序调用机制、CALL/RET 流程、栈帧示意 | [[26-子程序调用]] | 详述调用/返回指令、现场保护、递归与重入分析 |
| 函数与参数传递、调用约定、栈传参示例 | [[27-函数与参数]] | 覆盖寄存器/栈/混合传参、ARM AAPCS、返回值与清栈策略 |
| 程序执行三阶段、内存布局、执行循环 | [[28-程序执行过程]] | 展开编译-加载-运行流程、段结构与指令周期图 |

> 阅读顺序建议：先用 `26` 夯实调用栈概念，再通过 `27` 理解参数/约定差异，最后回到 `28` 构建“源代码→执行”的整体路径。

---

**说明**：本章仅保留提要与索引，图示/推导/习题仍在 `计算机组成原理/1-核心笔记/精简版/26~28`。待全部章节完成后，会统一清理旧版 A7 内容。

### 中断的作用

```
中断的本质：
  • 异步事件：随时可能发生
  • 打断当前：暂停当前任务
  • 处理事件：执行中断处理程序
  • 恢复原状：返回被打断的地方继续

作用：
  • 提高CPU利用率（不用轮询）
  • 及时响应外部事件
  • 实现多任务处理
  • 处理异常情况
```

---

## 二、中断分类

### 按来源分类

**通俗理解：** 中断可以按来源分为"内部事件"（内中断）和"外部事件"（外中断）。内中断是CPU内部的问题，外中断是外部设备需要CPU帮忙。

```
中断分类：
┌─────────────────────────────────────┐
│         中断分类                    │
├─────────────────────────────────────┤
│  内中断（异常/陷阱）                │
│  ├─ 硬件故障：除零、溢出、缺页      │
│  ├─ 软件中断：系统调用（INT指令）   │
│  └─ 陷阱：调试断点                  │
│                                     │
│  外中断（硬件中断）                │
│  ├─ 可屏蔽中断：I/O设备中断（IRQ）  │
│  └─ 不可屏蔽中断：电源故障（NMI）   │
└─────────────────────────────────────┘
```

### 内中断（异常）

**特点：**
- 由CPU内部事件引起
- 与当前指令执行相关
- 通常必须立即处理

**类型：**
- **故障（Fault）**：可恢复（如缺页）
- **陷阱（Trap）**：系统调用
- **中止（Abort）**：严重错误，可能无法恢复

### 外中断（硬件中断）

**特点：**
- 由外部设备请求
- 与当前指令执行无关
- 可屏蔽中断可以延迟处理

**类型：**
- **可屏蔽中断**：可通过中断屏蔽位禁止
- **不可屏蔽中断（NMI）**：必须立即处理（如电源故障）

---

## 三、中断处理流程

### 完整流程

**通俗理解：** 中断处理就像"接电话"：保存当前工作（保存断点）、接电话（处理中断）、挂电话后继续工作（恢复断点）。

```
中断处理8步骤：

步骤1: 保存断点
  SP ← SP - 4
  M[SP] ← PC（保存PC）
  M[SP-4] ← PSW（保存PSW）
  SP ← SP - 4

步骤2: 关中断
  IE ← 0（中断使能位清0）
  防止中断处理被打断（除非允许嵌套）

步骤3: 识别中断源
  读取中断状态寄存器
  判断哪个设备请求
  确定中断向量

步骤4: 转中断服务程序
  PC ← 中断向量表[n]
  n是中断类型编号

步骤5: 中断服务程序执行
  保存现场(寄存器)
  执行中断处理代码
  清除中断请求标志
  恢复现场(寄存器)

步骤6: 恢复断点
  PSW ← M[SP]
  SP ← SP + 4
  PC ← M[SP]
  SP ← SP + 4

步骤7: 开中断
  IE ← 1（中断使能位置1）
  允许响应新的中断

步骤8: 返回
  执行IRET指令
  继续原程序
```

### 中断时序图

```
主程序执行中:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
时间:  T1  T2  T3  T4  T5  T6  T7  T8  T9  T10
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: I1  I2  I3  ──  ──  ──  ──  ──  ──  I4
                   ↑                   ↑
                 中断请求             中断返回
                   │                   │
中断服务:          ├→ 保存 ISR ISR ISR ISR 恢复 ─┤
                      断点  1   2   3   4  断点
```

### 中断响应条件

```
中断响应条件：
  1. 中断源发出中断请求 (INT=1)
  2. 中断使能位IE=1
  3. 当前指令执行完毕

检查时机: 每条指令执行结束时

伪代码:
while (true) {
    执行当前指令;
    if (IE == 1 && INT == 1) {
        保存断点;
        关中断;
        跳转到中断服务程序;
    }
}
```

---

## 四、中断优先级

### 什么是中断优先级？

**通俗理解：** 中断优先级就像"紧急程度"，多个中断同时发生时，优先级高的先处理。

### 优先级排序

```
中断优先级排序 (典型):
┌─────────────────────┐
│ 1. 硬件故障中断      │ ← 最高优先级
│ 2. 程序性中断(异常)   │
│ 3. 外部中断          │
│    • 时钟中断        │
│    • I/O中断         │
│ 4. 软件中断          │ ← 最低优先级
└─────────────────────┘

中断优先级链:
  高优先级可以打断低优先级中断
  低优先级不能打断高优先级中断
```

### 中断嵌套

**通俗理解：** 中断嵌套就像"紧急电话可以打断普通电话"，高优先级中断可以打断低优先级中断的处理。

```
无嵌套 (单级中断):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: ════╗           ╔═══
            ║           ║
中断A:       ╚═══════════╝
            关中断     开中断

有嵌套 (多级中断):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
主程序: ════╗                 ╔═══
            ║                 ║
中断A:       ╚═════╗       ╔═══╝
                   ║       ║
中断B(高优先):      ╚═══════╝
                  关中断   开中断
```

---

## 五、中断向量表

### 什么是中断向量表？

**通俗理解：** 中断向量表就像"电话簿"，存储各种中断的服务程序入口地址。

### 中断向量表结构

```
中断向量表: 存储中断服务程序入口地址

地址      中断类型        服务程序地址
────────────────────────────────────
0x0000    复位           0x00100000
0x0004    除零异常       0x00100100
0x0008    非法指令       0x00100200
0x000C    溢出异常       0x00100300
0x0010    键盘中断       0x00100400
0x0014    定时器中断     0x00100500
0x0018    磁盘中断       0x00100600
...

中断响应过程:
  1. 读取中断类型n
  2. 查表: PC ← M[向量表基址 + n×4]
  3. 跳转到服务程序
```

### 中断向量表示例

```
中断类型编号 → 服务程序地址

示例：
  键盘中断：类型=4
  查表：向量表[4] = 0x00100400
  跳转：PC ← 0x00100400
  执行键盘中断服务程序
```

---

## 六、总结

### 核心要点

```
✅ 中断 = 异步事件打断当前程序
✅ 中断分类：内中断（异常）vs 外中断（硬件中断）
✅ 中断处理：保存断点 → 处理 → 恢复断点
✅ 中断优先级：高优先级可打断低优先级
✅ 中断向量表：存储服务程序入口地址
```

### 关键理解

- **中断**让CPU能及时响应外部事件，不用轮询
- **内中断**是CPU内部问题，**外中断**是外部设备请求
- **中断处理**必须保存和恢复现场
- **中断优先级**决定多个中断的处理顺序
- **中断向量表**快速定位服务程序

### 中断 vs 子程序调用

| 特性 | 中断 | 子程序调用 |
|------|------|-----------|
| **触发** | 异步(随机发生) | 同步(CALL指令) |
| **返回地址** | 硬件自动保存 | CALL指令保存 |
| **现场保护** | 可能需要保存所有 | 通常只保存必要寄存器 |
| **优先级** | 有优先级机制 | 无 |
| **嵌套** | 支持中断嵌套 | 支持递归调用 |
| **指令** | IRET | RET |

---

**最后更新：** 2025年1月

---
[原始文件: A6-总线与I-O系统.md]

# A6 总线与 I/O 系统

> 总线结构、I/O接口、DMA 与中断系统  
> 涵盖原文：22-总线系统、23-I/O接口、24-DMA技术、25-中断系统  
> 最后更新：2025年1月

---

## 📑 目录

- [一、总线基础](#一总线基础)
- [二、I/O 接口与编址](#二io-接口与编址)
- [三、数据传送方式](#三数据传送方式)
- [四、DMA 工作机制](#四dma-工作机制)
- [五、中断系统](#五中断系统)
- [六、易错点总结](#六易错点总结)

---

## 一、总线基础

### 1. 总线分类
| 类型 | 功能 | 示例 |
|------|------|------|
| 内部总线 | CPU 内部数据通路 | ALU ↔ 寄存器 |
| 系统总线 | CPU ↔ 主存 / I/O | 数据总线、地址总线、控制总线 |
| 通信总线 | 计算机 ↔ 计算机 | PCIe、USB、以太网 |

### 2. 总线事务与时序
- 事务阶段：仲裁 → 设定地址 → 数据传输 → 结束
- 同步方式：同步总线（统一时钟）、异步总线（握手协议）

### 3. 仲裁方式
| 方式 | 特点 |
|------|------|
| 集中式（链式/计数器/并行） | 控制简单，扩展性一般 |
| 分布式 | 设备自行协商，硬件复杂 |

---

## 二、I/O 接口与编址

### 1. I/O 接口组成
```
┌─────────────┐
│ 数据寄存器  │ ← 与设备/CPU数据交换
│ 状态寄存器  │ ← 标志位（忙/就绪/错误）
│ 控制寄存器  │ ← 控制命令（启动/停止）
└─────────────┘
```

### 2. I/O 编址方式
- **独立编址** (I/O-mapped)：I/O空间独立，使用特殊指令 (`IN/OUT`)
- **统一编址** (Memory-mapped)：I/O与内存统一编址，使用通用访存指令

---

## 三、数据传送方式

| 方式 | 特点 | 适用场景 |
|------|------|----------|
| 程序查询 | CPU轮询状态 | 低速设备、简单实现 |
| 程序中断 | 设备准备好后发中断，CPU响应 | 中速设备，减少轮询开销 |
| DMA | 设备直接访问主存 | 大批量高速数据传输 |

> 考试常比较“CPU占用率、硬件复杂度、吞吐率”

---

## 四、DMA 工作机制

### 1. DMA 过程
```
① CPU 初始化 DMA 控制器（源地址、目的地址、传输长度）
② DMA 请求总线控制权
③ DMA 在获得总线后直接在主存 ↔ I/O 之间传输
④ 传输完成后通过中断通知 CPU
```
- 工作方式：字节传送、块传送、周期窃取、透明传送
- **优点**：减少CPU干预、提高吞吐
- **限制**：主存与I/O带宽受总线冲突影响

---

## 五、中断系统

### 1. 中断类型
| 类型 | 触发方式 | 举例 |
|------|----------|------|
| 外部中断 | 外设请求 | 键盘输入、定时器 |
| 内部中断 | 指令异常 | 溢出、非法操作码 |
| 访管指令 | 特权调用 | OS服务调用 |

### 2. 中断响应流程
1. CPU 完成当前指令
2. 保存现场（PC、PSW）
3. 分析中断源（中断向量表）
4. 执行中断服务程序 (ISR)
5. 恢复现场，返回原程序

### 3. 中断优先级与屏蔽
- 多级优先级；高优先级可打断低优先级
- 屏蔽字：控制哪些中断能被响应
- 嵌套中断：ISR 中再次响应更高优先级中断

---

## 六、易错点总结

### 总线与性能
- **总线带宽** = 数据线宽度 (bit) × 总线频率
- **总线冲突**：多个设备同时请求总线 → 需仲裁

### DMA 与 Cache 冲突（高频考点）
```
问题：
  DMA绕过CPU直接访问主存
  → CPU的Cache中可能有旧数据
  → 数据不一致

解决方案：
  1. 硬件方案：Cache一致性协议（MESI）
  2. 软件方案：DMA前清空Cache / DMA后刷新Cache
  3. 混合方案：DMA通知Cache更新
```

### 中断处理
- **现场保存顺序**：先硬件自动保存PC/PSW，再由软件决定是否保存寄存器
- **中断嵌套**：高优先级中断可打断低优先级ISR
- **程序查询 vs 中断**：判断关键在于 CPU 是否需要主动轮询

---

详尽流程、时序图与计算示例请见原主题 `22~25`。
