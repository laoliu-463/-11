# 第6章：总线

---
[原始文件: 22-总线系统.md]

# 22-总线系统

> 总线结构、总线事务、总线仲裁  
> 最后更新：2025年1月

---

## 📑 目录

- [一、什么是总线？](#一什么是总线)
- [二、系统总线组成](#二系统总线组成)
- [三、总线事务](#三总线事务)
- [四、总线仲裁](#四总线仲裁)
- [五、总结](#五总结)

---

## 一、什么是总线？

### 定义

**定义：** 总线是连接各个计算机部件的公共通信通道，用于传输数据、地址和控制信号。

**通俗理解：** 总线就像"高速公路"，连接CPU、内存、I/O设备，所有数据都通过总线传输。总线分为地址总线（告诉去哪里）、数据总线（传输数据）、控制总线（控制信号）。

### 总线的特点

```
总线特点：
  • 共享的通信通道
  • 分时复用（不同时刻不同设备使用）
  • 传输数据、地址和控制信息
  • 连接CPU、内存、I/O设备

类比：
  总线 = 高速公路
  不同时刻只能有一个主设备使用
  就像高速公路上同一时刻只能有一辆车在某个位置
```

### 总线分类

```
按位置分类：
┌─────────────────────────────────────┐
│  片内总线（芯片内部）                │
│  CPU内部寄存器、ALU之间的连接        │
│  速度最快，宽度大                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  系统总线（主板上的总线）            │
│  CPU、内存、I/O设备之间的连接       │
│  分为：数据总线、地址总线、控制总线  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  通信总线（外部总线）                │
│  计算机与外部设备或计算机之间的连接  │
│  如：USB、PCIe、SATA                │
└─────────────────────────────────────┘
```

---

## 二、系统总线组成

### 三大总线

**通俗理解：** 系统总线就像"三条车道"：地址总线（告诉去哪里）、数据总线（传输什么）、控制总线（做什么操作）。

```
┌──────────────────────────────────────┐
│          系统总线                    │
├──────────────────────────────────────┤
│  ┌──────────────┐                   │
│  │  数据总线    │  双向传输数据      │
│  │ (Data Bus)   │  宽度：32/64位    │
│  └──────────────┘                   │
│                                      │
│  ┌──────────────┐                   │
│  │  地址总线    │  单向传输地址      │
│  │(Address Bus) │  宽度：32/64位    │
│  └──────────────┘                   │
│                                      │
│  ┌──────────────┐                   │
│  │  控制总线    │  传输控制信号      │
│  │(Control Bus) │  包括：读/写、中断 │
│  └──────────────┘                   │
└──────────────────────────────────────┘
```

### 1. 地址总线 (Address Bus)

**通俗理解：** 就像"地址牌"，告诉要去哪个地址。

```
功能：
  • 单向传输（CPU → 存储器/I/O）
  • 指定访问地址
  • 决定寻址空间

位宽与寻址空间：
  32位地址总线 → 2³² = 4GB
  64位地址总线 → 2⁶⁴ = 16EB

信号：
  • AB[31:0] (32位系统)
  • AB[63:0] (64位系统)
```

### 2. 数据总线 (Data Bus)

**通俗理解：** 就像"运输车"，传输实际的数据。

```
功能：
  • 双向传输（CPU ↔ 存储器/I/O）
  • 传输数据
  • 决定数据传输宽度

位宽：
  32位数据总线 → 一次传输4字节
  64位数据总线 → 一次传输8字节

信号：
  • DB[31:0] (32位系统)
  • DB[63:0] (64位系统)
```

### 3. 控制总线 (Control Bus)

**通俗理解：** 就像"指挥信号"，控制做什么操作。

```
功能：
  • 传输控制信号
  • 协调各部件工作

主要信号：
  • MREQ  (存储器请求)
  • IOREQ (I/O请求)
  • RD    (读信号)
  • WR    (写信号)
  • INT   (中断请求)
  • INTA  (中断响应)
  • BR    (总线请求)
  • BG    (总线授权)
  • CLK   (时钟)
  • RESET (复位)
```

---

## 三、总线事务

### 什么是总线事务？

**通俗理解：** 总线事务就像"一次完整的操作"，包括请求总线、传输数据、释放总线。

### 读存储器操作

```
步骤：
  T1: CPU将地址0x1000送到地址总线
      CPU发出MREQ和RD信号
  
  T2: 存储器译码地址
      准备数据
  
  T3: 存储器将数据送到数据总线
  
  T4: CPU从数据总线读取数据
      CPU撤销MREQ和RD信号

时序图:
       T1   T2   T3   T4
CLK    ┌─┐  ┌─┐  ┌─┐  ┌─┐
       │ │  │ │  │ │  │ │
AB     ──┬───────────────────
       │   0x1000
MREQ   ──┐               ┌───
         └───────────────┘
RD     ──┐               ┌───
         └───────────────┘
DB     ────────┬─────┬───────
               │Data │
```

### 写存储器操作

```
步骤：
  T1: CPU将地址送到地址总线
      CPU将数据送到数据总线
      CPU发出MREQ和WR信号
  
  T2: 存储器译码地址
      存储器读取数据总线
  
  T3: 存储器将数据写入
      CPU撤销MREQ和WR信号

时序图:
       T1   T2   T3
CLK    ┌─┐  ┌─┐  ┌─┐
       │ │  │ │  │ │
AB     ──┬───────────
       │   地址
MREQ   ──┐       ┌───
         └───────┘
WR     ──┐       ┌───
         └───────┘
DB     ──┬───────────
       │   数据
```

---

## 四、总线仲裁

### 什么是总线仲裁？

**通俗理解：** 总线仲裁就像"交通指挥"，当多个设备同时请求总线时，决定谁先使用。

### 链式查询方式

**通俗理解：** 就像"排队"，离仲裁器近的优先级高。

```
结构：
  CPU ──BR──→ 仲裁器
           ┌────┴────┐
          BG         BG
           ↓          ↓
         设备1 ─BG─→ 设备2 ─BG─→ 设备3

特点：
  • 简单，优先级固定
  • 离仲裁器近的优先级高
  • 但故障影响大（链式结构）
```

### 计数器定时查询

**通俗理解：** 就像"轮询"，仲裁器用计数器轮询各个设备。

```
结构：
  仲裁器用计数器轮询
  设备0 → 设备1 → 设备2 → ... → 设备n → 设备0

特点：
  • 较公平（轮询）
  • 可编程（设置起始设备）
  • 但需要计数器
```

### 独立请求方式

**通俗理解：** 就像"每个设备有独立的请求线"，最快但最复杂。

```
结构：
  每个设备有独立的BR和BG线
  仲裁器根据优先级决定

特点：
  • 最快（并行请求）
  • 最复杂（硬件开销大）
  • 优先级可编程
```

### 仲裁方式对比

| 方式 | 优点 | 缺点 | 应用 |
|------|------|------|------|
| **链式查询** | 简单 | 优先级固定，故障影响大 | 简单系统 |
| **计数器查询** | 较公平 | 需要计数器 | 中等系统 |
| **独立请求** | 最快 | 硬件复杂 | 高性能系统 |

---

## 五、总结

### 核心要点

```
✅ 总线 = 连接各部件的公共通信通道
✅ 系统总线 = 地址总线 + 数据总线 + 控制总线
✅ 地址总线：单向，指定地址
✅ 数据总线：双向，传输数据
✅ 控制总线：传输控制信号
✅ 总线仲裁：决定谁先使用总线
```

### 关键理解

- **总线**是共享通道，分时复用
- **地址总线**告诉去哪里，**数据总线**传输什么，**控制总线**控制操作
- **总线事务**包括请求、传输、释放
- **总线仲裁**解决多设备冲突问题
- **三种仲裁方式**各有优缺点

### 总线性能

```
性能指标：
  • 总线宽度：决定数据传输能力
  • 总线频率：决定传输速度
  • 总线带宽 = 宽度 × 频率

优化方向：
  • 增加总线宽度（32位→64位）
  • 提高总线频率
  • 使用多总线（分离指令和数据）
```

---

**最后更新：** 2025年1月

---
[原始文件: A6-总线与I-O系统.md]

# A6 总线与 I/O 系统

> 总线结构、I/O接口、DMA 与中断系统  
> 涵盖原文：22-总线系统、23-I/O接口、24-DMA技术、25-中断系统  
> 最后更新：2025年1月

---

## 📑 目录

- [一、总线基础](#一总线基础)
- [二、I/O 接口与编址](#二io-接口与编址)
- [三、数据传送方式](#三数据传送方式)
- [四、DMA 工作机制](#四dma-工作机制)
- [五、中断系统](#五中断系统)
- [六、易错点总结](#六易错点总结)

---

## 一、总线基础

### 1. 总线分类
| 类型 | 功能 | 示例 |
|------|------|------|
| 内部总线 | CPU 内部数据通路 | ALU ↔ 寄存器 |
| 系统总线 | CPU ↔ 主存 / I/O | 数据总线、地址总线、控制总线 |
| 通信总线 | 计算机 ↔ 计算机 | PCIe、USB、以太网 |

### 2. 总线事务与时序
- 事务阶段：仲裁 → 设定地址 → 数据传输 → 结束
- 同步方式：同步总线（统一时钟）、异步总线（握手协议）

### 3. 仲裁方式
| 方式 | 特点 |
|------|------|
| 集中式（链式/计数器/并行） | 控制简单，扩展性一般 |
| 分布式 | 设备自行协商，硬件复杂 |

---

## 二、I/O 接口与编址

### 1. I/O 接口组成
```
┌─────────────┐
│ 数据寄存器  │ ← 与设备/CPU数据交换
│ 状态寄存器  │ ← 标志位（忙/就绪/错误）
│ 控制寄存器  │ ← 控制命令（启动/停止）
└─────────────┘
```

### 2. I/O 编址方式
- **独立编址** (I/O-mapped)：I/O空间独立，使用特殊指令 (`IN/OUT`)
- **统一编址** (Memory-mapped)：I/O与内存统一编址，使用通用访存指令

---

## 三、数据传送方式

| 方式 | 特点 | 适用场景 |
|------|------|----------|
| 程序查询 | CPU轮询状态 | 低速设备、简单实现 |
| 程序中断 | 设备准备好后发中断，CPU响应 | 中速设备，减少轮询开销 |
| DMA | 设备直接访问主存 | 大批量高速数据传输 |

> 考试常比较“CPU占用率、硬件复杂度、吞吐率”

---

## 四、DMA 工作机制

### 1. DMA 过程
```
① CPU 初始化 DMA 控制器（源地址、目的地址、传输长度）
② DMA 请求总线控制权
③ DMA 在获得总线后直接在主存 ↔ I/O 之间传输
④ 传输完成后通过中断通知 CPU
```
- 工作方式：字节传送、块传送、周期窃取、透明传送
- **优点**：减少CPU干预、提高吞吐
- **限制**：主存与I/O带宽受总线冲突影响

---

## 五、中断系统

### 1. 中断类型
| 类型 | 触发方式 | 举例 |
|------|----------|------|
| 外部中断 | 外设请求 | 键盘输入、定时器 |
| 内部中断 | 指令异常 | 溢出、非法操作码 |
| 访管指令 | 特权调用 | OS服务调用 |

### 2. 中断响应流程
1. CPU 完成当前指令
2. 保存现场（PC、PSW）
3. 分析中断源（中断向量表）
4. 执行中断服务程序 (ISR)
5. 恢复现场，返回原程序

### 3. 中断优先级与屏蔽
- 多级优先级；高优先级可打断低优先级
- 屏蔽字：控制哪些中断能被响应
- 嵌套中断：ISR 中再次响应更高优先级中断

---

## 六、易错点总结

### 总线与性能
- **总线带宽** = 数据线宽度 (bit) × 总线频率
- **总线冲突**：多个设备同时请求总线 → 需仲裁

### DMA 与 Cache 冲突（高频考点）
```
问题：
  DMA绕过CPU直接访问主存
  → CPU的Cache中可能有旧数据
  → 数据不一致

解决方案：
  1. 硬件方案：Cache一致性协议（MESI）
  2. 软件方案：DMA前清空Cache / DMA后刷新Cache
  3. 混合方案：DMA通知Cache更新
```

### 中断处理
- **现场保存顺序**：先硬件自动保存PC/PSW，再由软件决定是否保存寄存器
- **中断嵌套**：高优先级中断可打断低优先级ISR
- **程序查询 vs 中断**：判断关键在于 CPU 是否需要主动轮询

---

详尽流程、时序图与计算示例请见原主题 `22~25`。
